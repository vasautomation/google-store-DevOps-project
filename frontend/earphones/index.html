
<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Google Store ‚Äî Earphones</title>
<link rel="icon" type="image/png" href="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c1/Google_%22G%22_logo.svg/1200px-Google_%22G%22_logo.svg.png">
<meta name="description" content="Advanced demo e-commerce template: dynamic, animated, carousel, cart, filters, offline" />
<link rel="stylesheet" href="style.css">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/gsap.min.js" defer></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.5/ScrollTrigger.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/swiper@10/swiper-bundle.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/vanilla-tilt@1.7.3/dist/vanilla-tilt.min.js" defer></script>
<script src="https://unpkg.com/feather-icons" defer></script>
<style>
:root {
  --glow: 0 0 16px #56e4ff99, 0 0 32px #46edb166;
  --accent: #55fef0;
  --accent2: #4da5e2;
  --card-bg: #181d26;
  --main-bg: #10141a;
}

body {
  background: var(--main-bg);
  min-height: 100vh;
  font-family: 'Inter', 'Roboto', Arial, sans-serif;
  overflow-x: hidden;
  position: relative;
}

/* Remove blur from reveal class */
.reveal { opacity:0; transform:translateY(55px) scale(0.97); transition:all 1s cubic-bezier(.67,0,.21,1); }
.reveal.show { opacity:1; transform:none; }
/* End blur change */

.preloader { position:fixed; top:0;left:0;width:100vw;height:100vh; display:flex; align-items:center; justify-content:center; background:#111a2566;z-index:200; transition:opacity 1.2s; }
.preloader .loader { text-align:center; }
.preloader .spin { width:74px;height:74px;stroke:#56e4ff;stroke-width:8; fill: none; animation:spin 1.3s infinite linear, glowspin 2.5s ease-in-out infinite alternate;}
@keyframes spin { 100% { transform:rotate(360deg); } }
@keyframes glowspin { 0% { filter: drop-shadow(var(--glow)); } 100% { filter: drop-shadow(0 0 0 #070a12);}}
.preloader .loader-text { color:var(--accent); font-size:1.16em; font-weight:500; letter-spacing:0.05em;}
.hero-card.floating {
  box-shadow: 0 8px 64px #0099ff46, 0 3px 8px #1bffff55, 0 0 42px #30fef688;
  animation:floating 2.3s ease-in-out infinite alternate;
  transition:box-shadow 0.3s;
  border-radius:16px;
  border:2px solid #4de7b422;
  background:linear-gradient(120deg,#232836 60%,rgba(77,247,244,0.18) 100%);
}
@keyframes floating { 0%{ transform:translateY(0px);} 100%{ transform:translateY(-14px) scale(1.016);} }
.hero-card:hover { box-shadow: 0 12px 88px #55fefb66, 0 1.5px 4.5px #4de7b466, var(--glow);}
.hero-info { background:rgba(20,22,32, 0.78); border-radius:0 0 16px 16px; padding:10px 14px;}
.btn.primary {
  background: linear-gradient(101deg,var(--accent) 65%,var(--accent2) 100%); color:#222;
  font-weight:bold;
  border:none;
  box-shadow:0 0 8px #62ffe888;
  transition:box-shadow 0.22s, transform 0.22s;
}
.btn.primary:hover { box-shadow:0 2px 28px #3ffdbb55, 0 0 0 #fff0; transform:translateY(-2.5px) scale(1.06);}
.btn.ghost {
  background: none;
  border:1.7px solid #3fe9f8;
  color:#4de7b4;
  transition:border 0.22s, box-shadow 0.32s, color 0.12s;
}
.btn.ghost:hover {
  border:1.7px solid var(--accent);
  color:var(--accent2);
  box-shadow:0 2px 16px #4de7b488;
}
#browseAll, #viewDeals { transition: box-shadow 0.33s, transform 0.33s;}
#browseAll:hover, #viewDeals:hover { box-shadow:0 4px 32px #30fdd888, var(--glow); transform:translateY(-5px) scale(1.09);}
.catalog .grid-view, .catalog .carousel-view {
  min-height: 410px; 
  will-change: opacity,transform;
  position:relative;
}
.earphone-card {
  background: var(--card-bg);
  border-radius:15px;
  transition: box-shadow 0.35s, background 0.2s, transform 0.22s;
  overflow:hidden;
  box-shadow: 0 1px 7px #4de7b41d;
  border:1.5px solid #0d324e1b;
  position:relative;
}
.earphone-card:hover {
  box-shadow:0 8px 42px #54fde76c, var(--glow);
  background:linear-gradient(102deg,#191f29 75%,#78ffe711 100%);
  transform:scale(1.03) rotate(-1.1deg);
}
.earphone-card .card-img {
  animation: cardPulse 2.7s infinite alternate;
  background: linear-gradient(97deg, #232c36 70%, #2fd6e733 100%);
}
@keyframes cardPulse {
  100% { box-shadow: 0 8px 22px #77fde692; }
}
.earphone-card .card-title { 
  text-shadow:0 2px 12px #192a36, 0 0 2px #fff8;
  transition: color 0.24s;
}
.earphone-card:hover .card-title {
  color: var(--accent2);
}
/* Modal advanced entry/exit  */
.modal-backdrop[aria-hidden="false"] {
  display: flex !important;
  align-items: center;
  justify-content: center;
  animation:fadeInBg 0.65s cubic-bezier(.8,.01,.45,1.05) both;
}
@keyframes fadeInBg { 0% { background:#10141a00; } 100% { background:#10141af2; }}
.modal-card {
  background: #161616;
  border-radius: 15px;
  box-shadow: 0 8px 44px #1d2128fa;
  position: relative;
  overflow:hidden;
  animation: modalPopIn 0.55s cubic-bezier(.4,2,0.3,1) both;
}
@keyframes modalPopIn { 0% { opacity:0; transform:scale(0.92) translateY(70px);} 100% { opacity:1; transform:none;}}
.svg-blob {
  position:absolute;
  /* Remove blur effect from svg-blob */
  /* filter: blur(24px); */
  z-index:0;
  pointer-events:none;
  user-select:none;
}

/* Payment animation styles */
#paymentModal[aria-hidden="false"] .modal-card {
  animation: payModalPop 0.67s cubic-bezier(.52,1.9,.27,1) both;
  box-shadow:0 8px 44px #45e8dd3b, 0 0 77px #24fbbb33;
  background: linear-gradient(104deg,#19303f 68%, #2fded7 100%);
}
@keyframes payModalPop { 0% { opacity:0; transform:scale(0.93) translateY(50px);}
  100% { opacity:1; transform:none;}
}

.site-footer .foot-grid { display: flex; justify-content: space-between; align-items: center;}
.site-footer { background: #090d13e9; margin-top:54px; border-top:1.5px solid #101b29; box-shadow:0 -3px 32px #1118;}
.site-footer strong { color:var(--accent2); }
.site-footer .muted { color:#85b4c9; font-size:0.97em; }
/* Custom animated scroll bar */
::-webkit-scrollbar { width: 10px; background:#181d26;}
::-webkit-scrollbar-thumb { border-radius: 6px; background: linear-gradient(98deg,#153241 40%,#178c7c);}
::-webkit-scrollbar-thumb:hover { background: linear-gradient(92deg,#29efa7,#3dd2fa); }
/* Switch */
.switch {
  position: relative; display: inline-block; width: 44px; height: 24px; vertical-align: middle;
}
.switch input { opacity: 0; width: 0; height: 0;}
.slider {
  position: absolute; top: 0; left: 0; right: 0; bottom: 0;
  background: #262b31; border-radius: 24px;
  transition: .4s;
}
.switch input:checked + .slider { background: linear-gradient(92deg,#32f9d3,#198ffb 80%);}
.slider:before {
  position: absolute; content: "";
  height: 18px; width: 18px; left: 4px; bottom: 3px;
  background: #fff; border-radius: 50%;
  transition: .4s;
  box-shadow:0 2px 9px #a9f7ff55;
}
.switch input:checked + .slider:before { transform: translateX(17px); background:var(--accent);}
</style>
</head>
<body data-category="earphones" data-theme="dark">
<div id="preloader" class="preloader" role="status" aria-live="polite">
  <div class="loader">
    <svg viewBox="0 0 100 100" class="spin"><circle cx="50" cy="50" r="40"></circle></svg>
    <div class="loader-text">Loading Google Store...</div>
  </div>
</div>

<header class="site-header" role="banner">
  <div class="nav-inner container">
      <span class="brand-text" style="animation:fadeInBrand 1.3s cubic-bezier(.6,0,.4,1) 0.6s both;">
       <img src="https://latestlogo.com/wp-content/uploads/2024/01/google-store-logo.png" alt="Google Store Logo" style="width:132px; height:66px; object-fit:contain; vertical-align:middle; margin-left:6px;">
      </span>
    <nav class="main-nav" aria-label="Primary">
      <ul>
        <li><a href="/earphones" class="active">Earphones</a></li>
      </ul>
    </nav>
    <div class="nav-actions" style="animation:navActionsIn 1.2s cubic-bezier(.56,0,.24,1) 0.2s both;">
      <div class="search-wrap">
        <input id="search" type="search" placeholder="Search products..." aria-label="Search products">
        <button id="clearSearch" class="icon-btn" title="Clear search" aria-hidden="true">‚úï</button>
      </div>
      <button id="viewToggle" class="icon-btn" title="Toggle view" aria-pressed="false">üîÅ</button>
      <button id="themeToggle" class="icon-btn" title="Toggle theme" aria-pressed="false">üåì</button>
      <button id="cartBtn" class="icon-btn cart-btn" aria-label="Open cart"><span style="filter:drop-shadow(0 0 7px #30ffd5cc)">üõí</span> <span id="cartCount" class="cart-count">0</span></button>
    </div>
  </div>
</header>

<!-- Removed parallax and background animation -->

<main class="container main" role="main">
  <section class="hero">
    <div class="hero-left reveal">
      <h1 id="page-title" style="animation:fadeWordIn 1.3s cubic-bezier(.72,0,.2,1) 0.5s both;">Earphones</h1>
      <p class="lead" id="page-sub" style="animation:fadeWordIn 1.6s cubic-bezier(.62,0,.29,1) 0.7s both"></p>
      <div class="hero-cta" style="animation:heroCtaIn 1.2s cubic-bezier(.62,-0.01,.35,1) 0.9s both;">
        <button id="browseAll" class="btn primary">Browse all</button>
        <button id="viewDeals" class="btn ghost">Top deals</button>
      </div>
      <div class="meta-row">
        <div class="muted">Free shipping | Secure checkout</div>
      </div>
    </div>
    <div class="hero-right reveal">
      <div class="hero-card floating" id="hero-feature">
        <svg class="svg-blob" width="330" height="170" viewBox="0 0 330 170" style="top:-39px; left:-51px;"><ellipse cx="150" cy="80" rx="172" ry="74" fill="#47f7ce22" /></svg>
        <img id="hero-image" src="https://via.placeholder.com/420x280?text=Feature" alt="Featured product" loading="lazy" style="z-index:1; animation:heroFloat 4.8s infinite alternate cubic-bezier(.3,0,.7,1);">
        <div class="hero-info">
          <div id="hero-name">Hot pick</div>
          <div id="hero-price">‚Çπ0</div>
        </div>
      </div>
    </div>
  </section>

  <section class="controls reveal">
    <div class="controls-left">
      <label>Sort:
        <select id="sort">
          <option value="featured">Featured</option>
          <option value="price-asc">Price: Low ‚Üí High</option>
          <option value="price-desc">Price: High ‚Üí Low</option>
          <option value="rating">Top rated</option>
        </select>
      </label>
      <label>Category:
        <select id="categoryFilter">
          <option value="all">All</option>
          <option value="new">New arrivals</option>
        </select>
      </label>
    </div>
    <div class="controls-right">
      <label class="switch">
        <input id="toggleLazy" type="checkbox" checked>
        <span class="slider"></span>
      </label>
      <small class="muted">Lazy images</small>
      <button id="gridBtn" class="btn small">Grid</button>
      <button id="carouselBtn" class="btn small ghost">Carousel</button>
    </div>
  </section>

  <section class="catalog reveal">
    <div id="gridView" class="grid-view" aria-live="polite" tabindex="-1"></div>
    <div id="carouselView" class="carousel-view" aria-hidden="true">
      <div class="swiper mySwiper" style="animation:popinSwiper 1.2s cubic-bezier(.5,.1,.2,1) both;">
        <div class="swiper-wrapper" id="swiperWrapper"></div>
        <div class="swiper-button-next"></div>
        <div class="swiper-button-prev"></div>
        <div class="swiper-pagination"></div>
      </div>
    </div>
  </section>
</main>

<div id="modal" class="modal-backdrop" aria-hidden="true" role="dialog" aria-modal="true">
  <div class="modal-card" role="document">
    <svg class="svg-blob" width="360" height="210" viewBox="0 0 360 210"><ellipse cx="175" cy="90" rx="170" ry="80" fill="#37fff355" /></svg>
    <button id="modalClose" class="close" aria-label="Close">‚úï</button>
    <div class="modal-grid">
      <div class="modal-media"><img id="modalImg" src="" alt="" loading="lazy" style="transition:transform 0.7s cubic-bezier(.47,1.7,.4,1);"></div>
      <div class="modal-content">
        <h2 id="modalTitle">Product</h2>
        <p id="modalDesc" class="muted">Description</p>
        <div id="modalPrice" class="price">‚Çπ0</div>
        <div class="modal-actions">
          <button id="modalAdd" class="btn primary">Add to cart</button>
          <button id="modalFav" class="btn ghost">‚ù§ Wishlist</button>
        </div>
      </div>
    </div>
  </div>
</div>

<aside id="cart" class="cart" aria-label="Shopping cart" aria-hidden="true" style="background: #000;transition:right 0.58s cubic-bezier(.17,.75,.39,1.28),box-shadow 0.28s;">
  <div class="cart-header">
    <h3>Cart</h3>
    <button id="cartClose" class="close" aria-label="Close">‚úï</button>
  </div>
  <div id="cartList" class="cart-list" tabindex="0"></div>
  <div class="cart-footer">
    <div class="total-row">
      <div class="muted">Total</div>
      <div id="cartTotal" class="price">‚Çπ0</div>
    </div>
    <div class="cart-actions">
      <button id="checkout" class="btn primary">Checkout</button>
      <button id="emptyCart" class="btn ghost">Empty</button>
    </div>
  </div>
</aside>

    
<!-- Payment Modal -->
<div id="paymentModal" class="modal-backdrop" aria-hidden="true" role="dialog" aria-modal="true" style="display:none">
  <div class="modal-card" role="document" style="max-width: 480px;">
    <button id="paymentClose" class="close" aria-label="Close" style="top:10px;right:10px;position:absolute;">‚úï</button>
    <div style="padding: 32px 24px 24px;">
      <h2 style="margin-top:0">Payment</h2>
      <!-- Customer info for UPI, only ask the first time before "I've Paid via UPI" -->
      <div id="customerInfoSection" style="display:none; margin-bottom: 20px;">
        <form id="upiCustomerForm" autocomplete="off" onsubmit="return false;" style="margin-bottom:0;">
          <div style="display:flex; gap:10px; margin-bottom:8px;">
            <label style="flex:1;">
              <span style="display:block;font-size:0.95em;margin-bottom:2px;">Name</span>
              <input id="customerNameInput" type="text" maxlength="50" required placeholder="Enter your name" style="width:100%;padding:6px;" autocomplete="off">
            </label>
          </div>
          <div style="display:flex; gap:10px;">
            <label style="flex:1;">
              <span style="display:block;font-size:0.95em;margin-bottom:2px;">Mobile</span>
              <input id="customerMobileInput" type="tel" maxlength="14" pattern="[0-9]{10,14}" required placeholder="Enter your mobile" style="width:100%;padding:6px;" autocomplete="off">
            </label>
          </div>
        </form>
        <div id="upiUserError" style="color:#e46c6c;font-size:0.96em;margin-top:6px;display:none;text-align:left;"></div>
      </div>
      <p class="muted">Choose your payment method:</p>
      <div style="margin: 24px 0;">
        <button class="btn primary" onclick="showPaymentTab('UPI')">UPI</button>
        <button class="btn ghost" onclick="showPaymentTab('Netbanking')">Net Banking</button>
        <button class="btn ghost" onclick="showPaymentTab('Card')">Credit/Debit Card</button>
      </div>
      <!-- Show Total Amount in Payment Modal -->
      <div id="totalAmountWrapper" style="margin-bottom: 24px; text-align:center;">
        <span style="font-size:1.1em;color:#fff;">Total Amount to Pay:&nbsp;</span>
        <span id="totalPaymentAmount" style="font-weight:bold;font-size:1.25em;color:#4dd784;">‚Çπ0</span>
      </div>
      <div id="paymentUPI" style="display:none;">
        <div style="margin-bottom:1em;">Pay to UPI ID: <strong>6303965190@kotak811</strong></div>
        <img src="https://i.ibb.co/84GXkSMt/pay.jpg" alt="UPI QR" style="display:block;margin:0 auto 1em auto;width:150px;height:150px;object-fit:contain;background:#fff;border-radius:8px;">
        <input id="upiInput" type="text" value="6303965190@kotak811" readonly style="width:100%;padding:6px;margin-bottom:1em;text-align:center;" onclick="this.select()">
        <div style="font-size:0.95em;color:#aaa; text-align:center;">Scan QR with any UPI app or copy/paste UPI ID</div>
        <button class="btn small" style="margin-top:1em" onclick="copyUPIID()">Copy UPI ID</button>
      </div>
      <div id="paymentNetbanking" style="display:none;">
        <form id="netbankingForm" onsubmit="event.preventDefault(); handlePaymentDone('Netbanking');">
          <label style="display:block; margin-bottom:8px;">Bank
            <select required style="width:100%;padding:6px;">
              <option value="">Choose bank</option>
              <option>SBI</option>
              <option>HDFC Bank</option>
              <option>Kotak Mahindra</option>
              <option>ICICI Bank</option>
              <option>Axis Bank</option>
              <option>Other...</option>
            </select>
          </label>
          <label style="display:block; margin-bottom:8px;">User ID
            <input type="text" required style="width:100%;padding:6px;" />
          </label>
          <label style="display:block; margin-bottom:16px;">Password
            <input type="password" required style="width:100%;padding:6px;" autocomplete="off"/>
          </label>
          <button class="btn primary" type="submit" style="width:100%;">Pay Now</button>
        </form>
      </div>
      <div id="paymentCard" style="display:none;">
        <form id="cardPaymentForm" onsubmit="event.preventDefault(); handlePaymentDone('Card');">
          <label style="display:block; margin-bottom:8px;">Card Number
            <input type="text" maxlength="19" pattern="\d*" inputmode="numeric" placeholder="XXXX XXXX XXXX XXXX" required style="width:100%;padding:6px;" />
          </label>
          <div style="display:flex;gap:8px;margin-bottom:8px;">
            <label style="flex:1;">Expiry
              <input type="text" maxlength="5" pattern="\d{2}/\d{2}" placeholder="MM/YY" required style="width:100%;padding:6px;" />
            </label>
            <label style="flex:1;">CVV
              <input type="password" maxlength="4" pattern="\d{3,4}" placeholder="CVV" required style="width:100%;padding:6px;" />
            </label>
          </div>
          <label style="display:block; margin-bottom:16px;">Name on card
            <input type="text" required style="width:100%;padding:6px;" />
          </label>
          <button class="btn primary" type="submit" style="width:100%;">Pay Now</button>
        </form>
      </div>
      <!-- Receipt Modal (hidden initially) -->
      <div id="receiptModal" style="display:none; background: #1e1e1e; border-radius: 8px; box-shadow:0 0 8px #0007; padding:28px 24px 24px 24px; text-align:center; margin-top:16px;">
        <h3 style="color:#4dd784; margin-bottom:0.5em;">Payment Successful!</h3>
        <div class="muted" style="margin-bottom:1em;">Thank you for your purchase.<br>Your payment has been received. <br>You can now view or download your receipt.</div>
        <button class="btn primary" onclick="viewReceipt()">View Receipt</button>
        <button class="btn ghost" style="margin-left:12px" onclick="downloadReceipt()">Download Receipt</button>
      </div>
      <!-- End receipt modal section -->
    </div>
  </div>
</div>
<style>
#paymentModal[aria-hidden="false"] { display: flex !important; align-items: center; justify-content: center; }
#paymentModal .modal-card { background: #161616; border-radius: 10px; box-shadow: 0 4px 32px #0008; }
</style>

<footer class="site-footer">
  <div class="container">
    <div class="foot-grid">
      <div>
        <strong>Google Store</strong>
        <p class="muted">developed by abinash kumar</p>
      </div>
      <div class="muted">¬© <span id="year"></span></div>
    </div>
  </div>
</footer>

<script src="script.js" defer></script>
<script>

// --- Receipt Data Extraction ---
function extractCartProducts() {
  const cartListElem = document.getElementById('cartList');
  if (!cartListElem || cartListElem.children.length === 0) return [];
  let products = [];
  for (const child of Array.from(cartListElem.children)) {
    let name = '', price = '', qty = 1, desc = '', img = '';

    if (child.querySelector) {
      let el;
      if ((el = child.querySelector('.cart-name'))) name = el.textContent.trim();
      if ((el = child.querySelector('.cart-price'))) price = el.textContent.trim();
      if ((el = child.querySelector('.cart-qty'))) qty = Number(el.textContent.trim()) || 1;
      if ((el = child.querySelector('.cart-desc'))) desc = el.textContent.trim();
      if ((el = child.querySelector('.cart-img')) && el.tagName.toLowerCase() === 'img') {
        img = el.src;
      } else if ((el = child.querySelector('img'))) {
        img = el.src;
      }
      if (!name || !price) {
        let text = child.textContent || '';
        let priceMatch = text.match(/‚Çπ\s*([0-9,.]+)/);
        if (priceMatch) price = '‚Çπ' + priceMatch[1];
        let qtyMatch = text.match(/x\s*(\d+)/);
        if (qtyMatch) qty = parseInt(qtyMatch[1]);
        if (priceMatch) {
          const beforePrice = text.slice(0, priceMatch.index).trim();
          name = beforePrice.replace(/x\s*\d+$/, '').trim();
        } else {
          name = text.split('‚Çπ')[0].replace(/x\s*\d+$/, '').trim();
        }
      }
    } else {
      let text = child.textContent || '';
      let priceMatch = text.match(/‚Çπ\s*([0-9,.]+)/);
      if (priceMatch) price = '‚Çπ' + priceMatch[1];
      let qtyMatch = text.match(/x\s*(\d+)/);
      if (qtyMatch) qty = parseInt(qtyMatch[1]);
      name = text.split('‚Çπ')[0].replace(/x\s*\d+$/, '').trim();
    }

    products.push({
      name,
      price,
      qty,
      desc,
      img
    });
  }
  return products;
}

// --- Customer info read helpers
let userEnteredCustomerName = null;
let userEnteredCustomerMobile = null;
let alreadyAskedCustomerInfo = false; // Only ask once per session/pay

function getCustomerName() {
  let activeTab = window._currentPaymentTab || 'UPI';
  if (activeTab === 'UPI') {
    if (typeof userEnteredCustomerName === 'string' && userEnteredCustomerName.trim() !== '') {
      return userEnteredCustomerName;
    }
    var nameInput = document.getElementById('customerNameInput');
    if (nameInput && nameInput.value.trim() !== '') {
      return nameInput.value.trim();
    }
  }
  // If no user info, send as 'Unknown' as per instructions
  return "Unknown";
}
function getCustomerMobile() {
  let activeTab = window._currentPaymentTab || 'UPI';
  if (activeTab === 'UPI') {
    if (typeof userEnteredCustomerMobile === 'string' && userEnteredCustomerMobile.trim() !== '') {
      return userEnteredCustomerMobile;
    }
    var mobileInput = document.getElementById('customerMobileInput');
    if (mobileInput && mobileInput.value.trim() !== '') {
      return mobileInput.value.trim();
    }
  }
  // If no user info, send as '0000000000' as per instructions
  return "0000000000";
}
function isValidMobile(mobile) {
  return /^[0-9]{10,14}$/.test(mobile);
}
function isCustomerFormValid() {
  let tab = window._currentPaymentTab || 'UPI';
  if (tab === 'UPI') {
    var nameInput = document.getElementById('customerNameInput');
    var mobileInput = document.getElementById('customerMobileInput');
    if (!nameInput || !mobileInput) return false;
    let nameValid = !!nameInput.value.trim();
    let mobileValid = isValidMobile(mobileInput.value.trim());
    return nameValid && mobileValid;
  }
  return true;
}
// Payment Modal Logic
const paymentModal = document.getElementById('paymentModal');
const paymentTabs = {
  UPI: document.getElementById('paymentUPI'),
  Netbanking: document.getElementById('paymentNetbanking'),
  Card: document.getElementById('paymentCard')
};
const customerInfoSection = document.getElementById('customerInfoSection');
const upiUserError = document.getElementById('upiUserError');

// Show/hide customer info: only show if UPI tab and before successful submit
function showPaymentTab(tab) {
  Object.values(paymentTabs).forEach(t => t.style.display = 'none');
  paymentTabs[tab].style.display = '';
  if (tab === 'UPI') {
    customerInfoSection.style.display = alreadyAskedCustomerInfo ? "none" : "block";
  } else {
    customerInfoSection.style.display = "none";
  }
  hideReceipt();
  window._currentPaymentTab = tab;
}

function openPaymentModal() {
  paymentModal.style.display = 'flex';
  paymentModal.setAttribute('aria-hidden', 'false');
  showPaymentTab('UPI');
  updateTotalPaymentAmount();
  hideReceipt();
  setTimeout(function(){
    if(window._currentPaymentTab === "UPI" && !alreadyAskedCustomerInfo) {
      const inp = document.getElementById('customerNameInput');
      if (inp) inp.focus();
    }
  }, 100);
}
function closePaymentModal() {
  paymentModal.style.display = 'none';
  paymentModal.setAttribute('aria-hidden', 'true');
  hideReceipt();
}
document.getElementById('paymentClose').onclick = closePaymentModal;

function hideReceipt() {
  const receiptDiv = document.getElementById("receiptModal");
  if (receiptDiv) receiptDiv.style.display = 'none';
}
function generateUPIQR() {}
function copyUPIID() {
  const input = document.getElementById("upiInput");
  input.select();
  input.setSelectionRange(0, 99999);
  document.execCommand("copy");
  alert("UPI ID Copied: " + input.value);
}

// =========================
// AUTO GENERATE + UPLOAD RECEIPT
// =========================

// Upload receipt to backend API
// NOTE: 'mobile' is NOT sent anymore due to backend MySQL schema error.
async function uploadReceiptToS3(receiptText, customerMobile) {
  try {
    const now = Date.now();
    const receiptFileName = `GoogleStoreReceipt_${customerMobile}_${now}.txt`;
    const res = await fetch("http://18.181.35.96:5002/save-receipts", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      // Remove 'mobile' field from payload due to backend column error
      body: JSON.stringify({
        filename: receiptFileName,
        receipt_text: receiptText
      })
    });
    const data = await res.json();
    if (!res.ok) throw new Error(data.error || "Upload failed");
    console.log("Receipt Saved:", data);
    alert("A copy of your receipt has been saved.");
    return data;
  } catch (err) {
    console.error("Upload Error:", err);
    alert("Error uploading receipt: " + err.message);
  }
}

// Main function: Generate + Upload the Receipt
async function autoSendReceiptToS3() {
  // Always use fallback values for "Customer Name" and "Mobile" if blank, and always send the section
  let customerName = getCustomerName();
  let customerMobile = getCustomerMobile();
  if (!customerName || customerName.trim() === "") customerName = "Unknown";
  if (!customerMobile || customerMobile.trim() === "") customerMobile = "0000000000";
  const date = new Date();
  const total = document.getElementById("totalPaymentAmount")?.textContent || "0";
  const products = extractCartProducts();

  // Format product lines
  let itemsText = "Products Purchased:\n";
  if (products.length > 0) {
    products.forEach(p => {
      itemsText += `- ${p.name || ''} | Qty: ${p.qty || ''} | Price: ${p.price || ''}\n`;
    });
  } else {
    // Always show this section, even if no products
    itemsText += "- No product details found\n";
  }

  // Always include Customer Name and Mobile lines, even if default values
  const receiptText = `
Google Store Receipt
-------------------------------------
Date: ${date.toLocaleString()}
Customer Name: ${customerName}
Mobile: ${customerMobile}
${itemsText}
-------------------------------------
Total Paid: ${total}
Payment Successful!
-------------------------------------
Developed by: Abinash Kumar
  `.trim();

  // Upload the receipt (do NOT send 'mobile' field in payload)
  await uploadReceiptToS3(receiptText, customerMobile);
}

// =========================
// CALL THIS WHEN PAYMENT SUCCESS
// =========================
// Example:
// document.getElementById("paymentSuccessBtn").addEventListener("click", autoSendReceiptToS3);


// Download receipt as text file (with products and customer info)
function downloadReceipt() {
  // Always use fallback values for "Customer Name" and "Mobile" if blank, and always send the section
  let customerName = getCustomerName();
  let customerMobile = getCustomerMobile();
  if (!customerName || customerName.trim() === "") customerName = "Unknown";
  if (!customerMobile || customerMobile.trim() === "") customerMobile = "0000000000";
  const date = new Date();
  const total = document.getElementById('totalPaymentAmount').textContent;
  let products = extractCartProducts();
  let itemsText = 'Products Purchased:\n';

  if (products.length > 0) {
    products.forEach(p => {
      itemsText += `- ${p.name || 'Product'}${p.desc ? ` (${p.desc})`:''} | Qty: ${p.qty || 1} | Price: ${p.price || ''}\n`;
    });
  } else {
    // Always show this header, even if no products
    itemsText += "- No product details found\n";
  }

  const lines = [
    'Google Store Receipt',
    '----------------------------',
    `Date: ${date.toLocaleString()}`,
    `Customer Name: ${customerName}`,
    `Mobile: ${customerMobile}`,
    itemsText.trim(),
    '----------------------------',
    `Total Paid: ${total}`,
    'Payment Successful!',
    '----------------------------',
    'Developed by abinash kumar'
  ];
  const receiptTxt = lines.join('\n');
  const blob = new Blob([receiptTxt],{type:'text/plain'});
  const link = document.createElement('a');
  link.href = URL.createObjectURL(blob);
  link.download = `GoogleStore_Receipt_${customerMobile}_${Date.now()}.txt`;
  link.click();
}

// Update the total amount in Payment Modal from cart
function updateTotalPaymentAmount() {
  let total = 0;
  const cartTotalElem = document.getElementById('cartTotal');
  if (cartTotalElem) {
    const value = cartTotalElem.textContent || '';
    const n = value.replace(/[^0-9.]/g,'');
    if (n) total = parseFloat(n);
  }
  const paymentAmountElem = document.getElementById('totalPaymentAmount');
  if(paymentAmountElem) {
    paymentAmountElem.textContent = '‚Çπ' + (isNaN(total) ? '0' : total);
  }
}

function clearCartAfterPayment() {
  const cartList = document.getElementById("cartList");
  if(cartList) cartList.innerHTML = "";
  const cartTotal = document.getElementById("cartTotal");
  if(cartTotal) cartTotal.textContent = '‚Çπ0';
  const cartCount = document.getElementById("cartCount");
  if(cartCount) cartCount.textContent = '0';
}

// Require customer info for UPI before payment
async function handlePaymentDone(method) {
  const isUPITab = (window._currentPaymentTab||'UPI') === "UPI";

  // Only ask info first time for UPI, never ask again
  if (isUPITab && !alreadyAskedCustomerInfo) {
    var nameInput = document.getElementById('customerNameInput');
    var mobileInput = document.getElementById('customerMobileInput');
    var errorDiv = document.getElementById('upiUserError');
    if (!nameInput || !mobileInput) return;
    let name = nameInput.value.trim();
    let mobile = mobileInput.value.trim();
    let hasError = false, errorMsg = "";
    if (!name) {
      hasError = true;
      errorMsg = "Please enter your name.";
    } else if (!isValidMobile(mobile)) {
      hasError = true;
      errorMsg = "Please enter a valid 10-14 digit mobile number.";
    }
    if (hasError) {
      if (errorDiv) { errorDiv.textContent = errorMsg; errorDiv.style.display = "block"; }
      if (!name) nameInput.focus();
      else mobileInput.focus();
      return;
    } else if (errorDiv) {
      errorDiv.style.display = "none";
      errorDiv.textContent = "";
    }
    userEnteredCustomerName = name;
    userEnteredCustomerMobile = mobile;
    alreadyAskedCustomerInfo = true;
    customerInfoSection.style.display = "none";
  }
  Object.values(paymentTabs).forEach(t => t.style.display = 'none');
  var receiptDiv = document.getElementById("receiptModal");
  if(receiptDiv){
    receiptDiv.style.display = 'block';
  }
  await autoSendReceiptToS3();
  // clearCartAfterPayment(); // optional
}

// Attach event to checkout button
document.addEventListener('DOMContentLoaded', function() {
  const checkoutBtn = document.getElementById('checkout');
  if(checkoutBtn){
    checkoutBtn.addEventListener('click', function(ev){
      ev.preventDefault();
      openPaymentModal();
    });
  }
  const cartTotalElem = document.getElementById('cartTotal');
  if(cartTotalElem) {
    const observer = new MutationObserver(updateTotalPaymentAmount);
    observer.observe(cartTotalElem, {childList:true, characterData:true, subtree:true});
  }
  // UPI paid button create
  const upiBtn = document.createElement('button');
  upiBtn.type = "button";
  upiBtn.textContent = "I've Paid via UPI";
  upiBtn.className = "btn primary";
  upiBtn.style = "margin-top:1.5em; width:100%";
  upiBtn.onclick = function(){ handlePaymentDone('UPI'); }
  const upiDiv = document.getElementById('paymentUPI');
  if(upiDiv && !document.getElementById("upiPaidBtn")){
    upiBtn.id = "upiPaidBtn";
    upiDiv.appendChild(upiBtn);
  }

  // Auto select tab and show customer info if tab is UPI on load, but never again after submitted
  showPaymentTab('UPI');
});

// When switching payment tabs manually, clear error and user-entered value only if not submitted yet
function resetCustomerInfoIfNeeded() {
  if (alreadyAskedCustomerInfo) {
    customerInfoSection.style.display = "none";
    return;
  }
  userEnteredCustomerName = null;
  userEnteredCustomerMobile = null;
  const nameInput = document.getElementById('customerNameInput');
  const mobileInput = document.getElementById('customerMobileInput');
  const errorDiv = document.getElementById('upiUserError');
  if (nameInput) nameInput.value = '';
  if (mobileInput) mobileInput.value = '';
  if (errorDiv) { errorDiv.textContent = ""; errorDiv.style.display = "none"; }
  if (window._currentPaymentTab === "UPI") {
    customerInfoSection.style.display = "block";
  }
}
document.querySelectorAll('button[onclick^="showPaymentTab"]').forEach(btn=>{
  btn.addEventListener('click',resetCustomerInfoIfNeeded);
});

paymentModal.addEventListener('mousedown', function(e) {
  if (e.target == paymentModal)
    closePaymentModal();
});



</script>  
  
<script src="script.js" defer></script>
</body>
</html>



